#!/bin/sh

# vim:sw=2:sts=2

tsocks="@prefix@/lib/libtsocks.so"

usage () {
  echo "Usage: $0 [options] [--] command [arguments...]"
  echo
  echo "Options:"
  echo -e "\t-h, --help"
  echo -e "\t\tShows this message."
  echo
  echo -e "\t-c FILE, --conf FILE"
  echo -e "\t\tUse specified configuration file instead of /etc/tsocks.conf."
  echo
  echo -e "\t-d N, --debug N"
  echo -e "\t\tSet debug level."
  echo
  echo -e "\t-f FILE, --debug-file FILE"
  echo -e "\t\tOutput debug messages to specified file."
  echo
  echo -e "\t-u USERNAME, --username USERNAME"
  echo -e "\t\tSet SOCKS username."
  echo
  echo -e "\t-p PASSWORD, --password PASSWORD"
  echo -e "\t\tSet SOCKS password."
}

enable () {
  disable
  if [ -z "$LD_PRELOAD" ]
  then
    export LD_PRELOAD="$tsocks"
  else
    export LD_PRELOAD="$tsocks $LD_PRELOAD"
  fi
}

disable () {
  temp="$LD_PRELOAD"
  unset LD_PRELOAD
  for so in $temp
  do
    if [ "$so" != "$tsocks" ]
    then
      if [ -z "$LD_PRELOAD" ]
      then
	export LD_PRELOAD="$so"
      else
	export LD_PRELOAD="$LD_PRELOAD $so"
      fi
    fi
  done
}

debuglvl=0

while [ $# -gt 0 ]
do
  case "$1" in

    -h|--help)
      usage
      exit 1
      ;;

    -c|--conf)
      shift
      export TSOCKS_CONF_FILE="$1"
      shift
      ;;

    -d|--debug)
      shift
      export TSOCKS_DEBUG="$1"
      shift
      ;;

    -f|--debug-file)
      shift
      export TSOCKS_DEBUG_FILE="$1"
      ;;

    -u|--username)
      shift
      export TSOCKS_USERNAME="$1"
      shift
      ;;

    -p|--password)
      shift
      export TSOCKS_PASSWORD="$1"
      shift
      ;;

    --)
      shift
      break
      ;;

    *)
      break
      ;;
  esac
done

enable

if [ $# = 0 ]
then
  usage
  exit 1
else
  exec "$@"
fi
